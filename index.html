<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <div id="app">
        <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                <p class="text-gray-600">Loading...</p>
            </div>
        </div>
    </div>

    <script>
        let auth, db;
        let currentUser = null;
        let currentClass = null;
        let classes = [];
        let deadlines = [];
        let posts = [];
        let groups = [];

        window.addEventListener('load', function() {
            if (typeof firebase === 'undefined') {
                document.getElementById('app').innerHTML = '<div class="min-h-screen flex items-center justify-center"><p class="text-red-600">Firebase failed to load. Please refresh.</p></div>';
                return;
            }

            const firebaseConfig = {
                apiKey: "AIzaSyCfijY0V4DQDOkrb13ludHiGRFtWsk8Bsg",
                authDomain: "student-hub-450ab.firebaseapp.com",
                databaseURL: "https://student-hub-450ab-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "student-hub-450ab",
                storageBucket: "student-hub-450ab.firebasestorage.app",
                messagingSenderId: "149361370872",
                appId: "1:149361370872:web:e3ee75310e59d92f3bbd0d"
            };

            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.database();

            auth.onAuthStateChanged(function(user) {
                if (user) {
                    currentUser = {
                        id: user.uid,
                        email: user.email,
                        name: user.displayName || user.email.split('@')[0]
                    };
                    loadUserClasses();
                } else {
                    currentUser = null;
                    currentClass = null;
                    render();
                }
            });

            render();
        });

        function loadUserClasses() {
            db.ref('users/' + currentUser.id + '/classes').on('value', function(snapshot) {
                var data = snapshot.val();
                classes = data ? Object.values(data) : [];
                render();
            });
        }

        function loadClassData(classId) {
            db.ref('classes/' + classId + '/deadlines').on('value', function(snapshot) {
                deadlines = snapshot.val() ? Object.values(snapshot.val()) : [];
                render();
            });

            db.ref('classes/' + classId + '/posts').on('value', function(snapshot) {
                posts = snapshot.val() ? Object.values(snapshot.val()) : [];
                render();
            });

            db.ref('classes/' + classId + '/groups').on('value', function(snapshot) {
                groups = snapshot.val() ? Object.values(snapshot.val()) : [];
                render();
            });
        }

        function handleSignup(name, email, password) {
            auth.createUserWithEmailAndPassword(email, password)
                .then(function(userCredential) {
                    if (name) {
                        return userCredential.user.updateProfile({ displayName: name });
                    }
                })
                .then(function() {
                    alert('Account created!');
                })
                .catch(function(error) {
                    alert('Error: ' + error.message);
                });
        }

        function handleLogin(email, password) {
            auth.signInWithEmailAndPassword(email, password)
                .catch(function(error) {
                    alert('Error: ' + error.message);
                });
        }

        function handleLogout() {
            auth.signOut();
            currentClass = null;
        }

        function createClass(name) {
            var newClass = {
                id: Date.now().toString(),
                name: name,
                inviteCode: Math.random().toString(36).substring(2, 8).toUpperCase(),
                createdBy: currentUser.id,
                createdAt: Date.now()
            };

            db.ref('users/' + currentUser.id + '/classes/' + newClass.id).set(newClass);
            db.ref('classes/' + newClass.id + '/info').set(newClass);
            
            currentClass = newClass;
            loadClassData(newClass.id);
            render();
        }

        function selectClass(cls) {
            currentClass = cls;
            loadClassData(cls.id);
            render();
        }

        function addDeadline(title, date, subject) {
            var deadline = {
                id: Date.now().toString(),
                title: title,
                date: date,
                subject: subject,
                createdBy: currentUser.id,
                createdAt: Date.now()
            };
            db.ref('classes/' + currentClass.id + '/deadlines/' + deadline.id).set(deadline);
        }

        function addPost(title, description) {
            var post = {
                id: Date.now().toString(),
                title: title,
                description: description,
                author: currentUser.name,
                authorId: currentUser.id,
                timestamp: Date.now()
            };
            db.ref('classes/' + currentClass.id + '/posts/' + post.id).set(post);
        }

        function addGroup(name, time, members) {
            var group = {
                id: Date.now().toString(),
                name: name,
                time: time,
                members: members,
                creator: currentUser.name,
                creatorId: currentUser.id,
                createdAt: Date.now()
            };
            db.ref('classes/' + currentClass.id + '/groups/' + group.id).set(group);
        }

        function render() {
            var app = document.getElementById('app');
            
            if (!currentUser) {
                app.innerHTML = renderLogin();
            } else if (!currentClass) {
                app.innerHTML = renderClassSelection();
            } else {
                app.innerHTML = renderMainApp();
            }
        }

        function renderLogin() {
            return '<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">' +
                '<div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">' +
                '<div class="text-center mb-8">' +
                '<div class="bg-indigo-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">' +
                '<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">' +
                '<path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>' +
                '<path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>' +
                '</svg></div>' +
                '<h1 class="text-3xl font-bold text-gray-800">Student Hub</h1>' +
                '<p class="text-gray-600 mt-2">Collaborate, study, and succeed together</p>' +
                '</div>' +
                '<div class="flex gap-2 mb-6">' +
                '<button onclick="showLogin()" id="login-tab" class="flex-1 py-2 rounded-lg font-medium bg-indigo-600 text-white">Login</button>' +
                '<button onclick="showSignup()" id="signup-tab" class="flex-1 py-2 rounded-lg font-medium bg-gray-100 text-gray-600">Sign Up</button>' +
                '</div>' +
                '<div id="login-form">' +
                '<div class="space-y-4">' +
                '<input type="email" id="login-email" placeholder="Email" class="w-full px-4 py-3 border border-gray-300 rounded-lg">' +
                '<input type="password" id="login-password" placeholder="Password" class="w-full px-4 py-3 border border-gray-300 rounded-lg">' +
                '<button onclick="submitLogin()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-medium hover:bg-indigo-700">Login</button>' +
                '</div></div>' +
                '<div id="signup-form" style="display:none;">' +
                '<div class="space-y-4">' +
                '<input type="text" id="signup-name" placeholder="Full Name" class="w-full px-4 py-3 border border-gray-300 rounded-lg">' +
                '<input type="email" id="signup-email" placeholder="Email" class="w-full px-4 py-3 border border-gray-300 rounded-lg">' +
                '<input type="password" id="signup-password" placeholder="Password" class="w-full px-4 py-3 border border-gray-300 rounded-lg">' +
                '<button onclick="submitSignup()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-medium hover:bg-indigo-700">Sign Up</button>' +
                '</div></div>' +
                '<p class="text-xs text-gray-500 text-center mt-6">üî• Powered by Firebase</p>' +
                '</div></div>';
        }

        function renderClassSelection() {
            var classesHTML = '';
            if (classes.length > 0) {
                classesHTML = '<div><h2 class="text-xl font-semibold text-gray-800 mb-4">Your Classes</h2><div class="grid md:grid-cols-3 gap-4">';
                classes.forEach(function(cls) {
                    classesHTML += '<button onclick=\'selectClass(' + JSON.stringify(cls) + ')\' class="bg-white rounded-xl p-6 shadow-md hover:shadow-lg transition text-left">' +
                        '<h3 class="text-lg font-semibold text-gray-800">' + cls.name + '</h3>' +
                        '<p class="text-sm text-gray-600 mt-2">Code: ' + cls.inviteCode + '</p></button>';
                });
                classesHTML += '</div></div>';
            }

            return '<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">' +
                '<div class="max-w-4xl mx-auto">' +
                '<div class="flex justify-between items-center mb-8">' +
                '<div><h1 class="text-3xl font-bold text-gray-800">Welcome, ' + currentUser.name + '!</h1>' +
                '<p class="text-gray-600 mt-1">Select a class or create a new one</p></div>' +
                '<button onclick="handleLogout()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Logout</button>' +
                '</div>' +
                '<div class="grid md:grid-cols-2 gap-4 mb-6">' +
                '<button onclick="showCreateClassModal()" class="bg-white rounded-xl p-6 shadow-md hover:shadow-lg transition border-2 border-dashed border-indigo-300">' +
                '<p class="text-4xl mb-3">‚ûï</p><h3 class="text-xl font-semibold text-gray-800">Create New Class</h3></button>' +
                '<button onclick="alert(\'Join feature coming soon!\')" class="bg-white rounded-xl p-6 shadow-md hover:shadow-lg transition border-2 border-gray-200">' +
                '<p class="text-4xl mb-3">‚úâÔ∏è</p><h3 class="text-xl font-semibold text-gray-800">Join with Code</h3></button>' +
                '</div>' + classesHTML +
                '</div></div>';
        }

        function renderMainApp() {
            return '<div class="min-h-screen bg-gray-50 flex">' +
                '<div class="w-64 bg-white border-r border-gray-200 flex flex-col">' +
                '<div class="p-6 border-b border-gray-200">' +
                '<h2 class="text-2xl font-bold text-indigo-600">' + currentClass.name + '</h2>' +
                '<p class="text-sm text-gray-600 mt-1">' + currentUser.name + '</p></div>' +
                '<nav class="flex-1 p-4">' +
                '<button onclick="showTab(\'deadlines\')" id="tab-deadlines" class="w-full px-4 py-3 rounded-lg mb-2 bg-indigo-50 text-indigo-600 text-left">üìÖ Deadlines</button>' +
                '<button onclick="showTab(\'homework\')" id="tab-homework" class="w-full px-4 py-3 rounded-lg mb-2 text-gray-700 hover:bg-gray-50 text-left">üí¨ Homework Help</button>' +
                '<button onclick="showTab(\'groups\')" id="tab-groups" class="w-full px-4 py-3 rounded-lg mb-2 text-gray-700 hover:bg-gray-50 text-left">üë• Study Groups</button>' +
                '</nav>' +
                '<div class="p-4 border-t border-gray-200">' +
                '<button onclick="showInviteModal()" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg mb-2">Invite</button>' +
                '<button onclick="currentClass = null; render()" class="w-full px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Change Class</button>' +
                '</div></div>' +
                '<div class="flex-1 p-8 overflow-y-auto">' +
                '<div id="tab-content-deadlines">' + renderDeadlines() + '</div>' +
                '<div id="tab-content-homework" style="display:none;">' + renderHomework() + '</div>' +
                '<div id="tab-content-groups" style="display:none;">' + renderGroups() + '</div>' +
                '</div></div>' +
                '<div id="modal-overlay" style="display:none;" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="closeModals()">' +
                '<div onclick="event.stopPropagation()" class="bg-white rounded-2xl p-6 w-full max-w-md" id="modal-content"></div></div>';
        }

        function renderDeadlines() {
            var html = '<h1 class="text-3xl font-bold text-gray-800 mb-6">Deadlines</h1>' +
                '<div class="bg-white rounded-xl shadow-md p-6 mb-6">' +
                '<h2 class="text-xl font-semibold text-gray-800 mb-4">Add New Deadline</h2>' +
                '<div class="grid md:grid-cols-3 gap-4">' +
                '<input type="text" id="deadline-title" placeholder="Assignment title" class="px-4 py-2 border rounded-lg">' +
                '<input type="date" id="deadline-date" class="px-4 py-2 border rounded-lg">' +
                '<input type="text" id="deadline-subject" placeholder="Subject" class="px-4 py-2 border rounded-lg">' +
                '<button onclick="submitDeadline()" class="md:col-span-3 bg-indigo-600 text-white py-2 rounded-lg">Add</button>' +
                '</div></div><div class="space-y-4">';

            if (deadlines.length === 0) {
                html += '<p class="text-gray-600 text-center py-8">No deadlines yet</p>';
            } else {
                deadlines.forEach(function(d) {
                    html += '<div class="bg-white rounded-lg shadow-md p-6">' +
                        '<div class="flex justify-between"><div><h3 class="text-lg font-semibold">' + d.title + '</h3>' +
                        (d.subject ? '<span class="inline-block mt-2 px-3 py-1 bg-indigo-100 text-indigo-700 text-sm rounded-full">' + d.subject + '</span>' : '') +
                        '</div><div class="text-right"><p class="text-sm text-gray-600">Due Date</p><p class="text-lg font-semibold">' + d.date + '</p></div></div></div>';
                });
            }
            return html + '</div>';
        }

        function renderHomework() {
            var html = '<h1 class="text-3xl font-bold text-gray-800 mb-6">Homework Help</h1>' +
                '<div class="bg-white rounded-xl shadow-md p-6 mb-6">' +
                '<h2 class="text-xl font-semibold text-gray-800 mb-4">Ask for Help</h2>' +
                '<div class="space-y-4">' +
                '<input type="text" id="post-title" placeholder="Question title" class="w-full px-4 py-2 border rounded-lg">' +
                '<textarea id="post-description" placeholder="Describe your question..." rows="4" class="w-full px-4 py-2 border rounded-lg"></textarea>' +
                '<button onclick="submitPost()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg">Post</button>' +
                '</div></div><div class="space-y-4">';

            if (posts.length === 0) {
                html += '<p class="text-gray-600 text-center py-8">No questions yet</p>';
            } else {
                posts.forEach(function(p) {
                    html += '<div class="bg-white rounded-lg shadow-md p-6">' +
                        '<div class="flex gap-4"><div class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center text-white font-semibold">' + p.author[0] + '</div>' +
                        '<div class="flex-1"><div class="flex gap-2 mb-2"><span class="font-semibold">' + p.author + '</span>' +
                        '<span class="text-sm text-gray-500">' + new Date(p.timestamp).toLocaleDateString() + '</span></div>' +
                        '<h3 class="text-lg font-semibold mb-2">' + p.title + '</h3>' +
                        '<p class="text-gray-600">' + p.description + '</p></div></div></div>';
                });
            }
            return html + '</div>';
        }

        function renderGroups() {
            var html = '<h1 class="text-3xl font-bold text-gray-800 mb-6">Study Groups</h1>' +
                '<div class="bg-white rounded-xl shadow-md p-6 mb-6">' +
                '<h2 class="text-xl font-semibold text-gray-800 mb-4">Create Study Group</h2>' +
                '<div class="space-y-4">' +
                '<input type="text" id="group-name" placeholder="Group name" class="w-full px-4 py-2 border rounded-lg">' +
                '<input type="text" id="group-time" placeholder="Meeting time" class="w-full px-4 py-2 border rounded-lg">' +
                '<input type="text" id="group-members" placeholder="Max members" class="w-full px-4 py-2 border rounded-lg">' +
                '<button onclick="submitGroup()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg">Create</button>' +
                '</div></div><div class="grid md:grid-cols-2 gap-4">';

            if (groups.length === 0) {
                html += '<p class="text-gray-600 text-center py-8 col-span-2">No groups yet</p>';
            } else {
                groups.forEach(function(g) {
                    html += '<div class="bg-white rounded-lg shadow-md p-6">' +
                        '<h3 class="text-lg font-semibold mb-2">' + g.name + '</h3>' +
                        '<p class="text-sm text-gray-600 mb-1">Created by: ' + g.creator + '</p>' +
                        (g.time ? '<p class="text-sm text-gray-600 mb-1">Meets: ' + g.time + '</p>' : '') +
                        (g.members ? '<p class="text-sm text-gray-600 mb-4">Max: ' + g.members + '</p>' : '') +
                        '<button class="w-full bg-indigo-600 text-white py-2 rounded-lg">Join</button></div>';
                });
            }
            return html + '</div>';
        }

        function showLogin() {
            document.getElementById('login-tab').className = 'flex-1 py-2 rounded-lg font-medium bg-indigo-600 text-white';
            document.getElementById('signup-tab').className = 'flex-1 py-2 rounded-lg font-medium bg-gray-100 text-gray-600';
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('signup-form').style.display = 'none';
        }

        function showSignup() {
            document.getElementById('signup-tab').className = 'flex-1 py-2 rounded-lg font-medium bg-indigo-600 text-white';
            document.getElementById('login-tab').className = 'flex-1 py-2 rounded-lg font-medium bg-gray-100 text-gray-600';
            document.getElementById('signup-form').style.display = 'block';
            document.getElementById('login-form').style.display = 'none';
        }

        function submitLogin() {
            var email = document.getElementById('login-email').value;
            var password = document.getElementById('login-password').value;
            handleLogin(email, password);
        }

        function submitSignup() {
            var name = document.getElementById('signup-name').value;
            var email = document.getElementById('signup-email').value;
            var password = document.getElementById('signup-password').value;
            handleSignup(name, email, password);
        }

        function showCreateClassModal() {
            document.getElementById('modal-overlay').style.display = 'flex';
            document.getElementById('modal-content').innerHTML =
                '<h2 class="text-2xl font-bold mb-4">Create New Class</h2>' +
                '<input type="text" id="new-class-name" placeholder="Class Name" class="w-full px-4 py-3 border rounded-lg mb-4">' +
                '<div class="flex gap-3">' +
                '<button onclick="closeModals()" class="flex-1 px-4 py-2 border rounded-lg">Cancel</button>' +
                '<button onclick="submitCreateClass()" class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg">Create</button>' +
                '</div>';
        }

        function submitCreateClass() {
            var name = document.getElementById('new-class-name').value;
            if (name.trim()) {
                createClass(name);
                closeModals();
            }
        }

        function showInviteModal() {
            document.getElementById('modal-overlay').style.display = 'flex';
            document.getElementById('modal-content').innerHTML =
                '<h2 class="text-2xl font-bold mb-4">Invite Students</h2>' +
                '<p class="text-gray-600 mb-4">Share this code:</p>' +
                '<div class="bg-indigo-50 rounded-lg p-4 mb-4">' +
                '<p class="text-center text-3xl font-bold text-indigo-600">' + currentClass.inviteCode + '</p>' +
                '</div>' +
                '<button onclick="copyInviteCode()" class="w-full bg-indigo-600 text-white py-3 rounded-lg mb-3">Copy Code</button>' +
                '<button onclick="closeModals()" class="w-full py-2 text-gray-600">Close</button>';
        }

        function copyInviteCode() {
            navigator.clipboard.writeText(currentClass.inviteCode);
            alert('Code copied!');
        }

        function closeModals() {
            document.getElementById('modal-overlay').style.display = 'none';
        }

        function showTab(tab) {
            document.getElementById('tab-content-deadlines').style.display = 'none';
            document.getElementById('tab-content-homework').style.display = 'none';
            document.getElementById('tab-content-groups').style.display = 'none';
            
            document.getElementById('tab-deadlines').className = 'w-full px-4 py-3 rounded-lg mb-2 text-gray-700 hover:bg-gray-50 text-left';
            document.getElementById('tab-homework').className = 'w-full px-4 py-3 rounded-lg mb-2 text-gray-700 hover:bg-gray-50 text-left';
            document.getElementById('tab-groups').className = 'w-full px-4 py-3 rounded-lg mb-2 text-gray-700 hover:bg-gray-50 text-left';
            
            document.getElementById('tab-content-' + tab).style.display = 'block';
            document.getElementById('tab-' + tab).className = 'w-full px-4 py-3 rounded-lg mb-2 bg-indigo-50 text-indigo-600 text-left';
        }

        function submitDeadline() {
            var title = document.getElementById('deadline-title').value;
            var date = document.getElementById('deadline-date').value;
            var subject = document.getElementById('deadline-subject').value;
            if (title && date) {
                addDeadline(title, date, subject);
                document.getElementById('deadline-title').value = '';
                document.getElementById('deadline-date').value = '';
                document.getElementById('deadline-subject').value = '';
            }
        }

        function submitPost() {
            var title = document.getElementById('post-title').value;
            var description = document.getElementById('post-description').value;
            if (title) {
                addPost(title, description);
                document.getElementById('post-title').value = '';
                document.getElementById('post-description').value = '';
            }
        }

        function submitGroup() {
            var name = document.getElementById('group-name').value;
            var time = document.getElementById('group-time').value;
            var members = document.getElementById('group-members').value;
            if (name) {
                addGroup(name, time, members);
                document.getElementById('group-name').value = '';
                document.getElementById('group-time').value = '';
                document.getElementById('group-members').value = '';
            }
        }
    </script>
</body>
</html>