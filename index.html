<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Student Hub â€” Realtime Chat</title>
<style>
  :root{
    --bg:#f3f6ff; --card:#fff; --indigo:#4F46E5; --muted:#6b7280;
  }
  *{box-sizing:border-box}
  body{font-family:Inter,ui-sans-serif,system-ui,Roboto,Helvetica,Arial; margin:0; background:linear-gradient(135deg,#EBF4FF 0%,#E0E7FF 100%); min-height:100vh}
  .app{max-width:1100px;margin:24px auto;padding:16px;display:grid;grid-template-columns:260px 1fr;gap:16px}
  .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(15,23,42,0.06)}
  .sidebar{display:flex;flex-direction:column;height:80vh}
  .logo{display:flex;align-items:center;gap:10px;padding:8px 0}
  .avatar{width:38px;height:38px;border-radius:8px;background:var(--indigo);color:white;display:flex;align-items:center;justify-content:center;font-weight:700}
  .small{font-size:13px;color:var(--muted)}
  .btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
  .btn-primary{background:var(--indigo);color:white}
  .btn-ghost{background:transparent;border:1px solid #e6e9f8;color:var(--indigo)}
  .list{margin-top:8px;overflow:auto;padding-right:6px}
  .class-item{padding:10px;border-radius:8px;cursor:pointer;margin-bottom:8px}
  .class-item:hover{background:#f4f6ff}
  .class-selected{background:#eef2ff;border:1px solid #e0e7ff}
  .channels{margin-top:12px}
  .channel{padding:8px;border-radius:8px;cursor:pointer}
  .channel.active{background:#eef2ff;color:var(--indigo);font-weight:700}
  .main{display:flex;flex-direction:column;height:80vh}
  .header{display:flex;align-items:center;justify-content:space-between;padding:8px 0}
  .chat-area{flex:1;padding:12px;overflow:auto;border-radius:10px;background:#fbfcff;border:1px solid #f1f5f9}
  .msg{display:flex;gap:10px;margin-bottom:12px}
  .msg .bubble{background:white;padding:10px;border-radius:8px;box-shadow:0 3px 10px rgba(15,23,42,0.03);max-width:70%}
  .msg.me{flex-direction:row-reverse}
  .msg.me .bubble{background:var(--indigo);color:white}
  .compose{display:flex;gap:8px;padding-top:10px}
  input[type="text"], textarea{padding:10px;border-radius:8px;border:1px solid #e6e9f8;flex:1}
  .muted{color:var(--muted);font-size:13px}
  @media(max-width:900px){.app{grid-template-columns:1fr;}.sidebar{height:auto}}
</style>
<!-- Firebase compat (same as your original) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
<div class="app">
  <!-- SIDEBAR -->
  <div class="card sidebar" id="sidebar">
    <div class="logo">
      <div class="avatar">SH</div>
      <div>
        <div style="font-weight:700" id="user-name">Loading...</div>
        <div class="small" id="user-email"></div>
      </div>
    </div>

    <div style="margin-top:8px">
      <button class="btn btn-primary" id="create-class-btn">+ Create Class</button>
      <button class="btn btn-ghost" id="join-code-btn" style="margin-left:8px">Join</button>
    </div>

    <h4 style="margin-top:12px;margin-bottom:6px">Your Classes</h4>
    <div class="list" id="classes-list" style="flex:0 1 200px"></div>

    <h4 style="margin-top:10px;margin-bottom:6px">Channels</h4>
    <div class="channels card" id="channels-list" style="flex:1;overflow:auto;padding:8px"></div>

    <div style="margin-top:auto;padding-top:8px">
      <div class="small" id="presence-info">No class selected</div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="btn btn-ghost" id="logout-btn">Logout</button>
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="card main" id="main">
    <div class="header">
      <div>
        <div style="font-weight:700" id="class-title">Select or create a class</div>
        <div class="small" id="class-sub">Invite code: -</div>
      </div>
      <div class="small" id="online-count">Online: 0</div>
    </div>

    <div class="chat-area" id="chat-area">
      <div class="muted" style="text-align:center;margin-top:20px">Join a class and select a channel to start chatting</div>
    </div>

    <div style="padding-top:8px">
      <div style="display:flex;align-items:center;gap:8px;">
        <div id="typing-indicator" class="small muted" style="flex:1"></div>
        <div class="small" id="last-seen"></div>
      </div>

      <div class="compose" style="margin-top:8px">
        <input type="text" id="message-input" placeholder="Write a message..." disabled>
        <button class="btn btn-primary" id="send-btn" disabled>Send</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal area (simple) -->
<div id="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);align-items:center;justify-content:center">
  <div style="background:white;padding:16px;border-radius:10px;min-width:300px;max-width:90%">
    <div id="modal-body"></div>
    <div style="margin-top:12px;text-align:right"><button id="modal-close" class="btn btn-ghost">Close</button></div>
  </div>
</div>

<script>
/* ======= CONFIG - replace with your own or keep user's config ======= */
const firebaseConfig = {
  apiKey: "AIzaSyCfijY0V4DQDOkrb13ludHiGRFtWsk8Bsg",
  authDomain: "student-hub-450ab.firebaseapp.com",
  databaseURL: "https://student-hub-450ab-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "student-hub-450ab",
  storageBucket: "student-hub-450ab.firebasestorage.app",
  messagingSenderId: "149361370872",
  appId: "1:149361370872:web:e3ee75310e59d92f3bbd0d"
};
/* ================================================================== */

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

/* -------------------------
   App state
------------------------- */
let currentUser = null;
let classes = []; // array of class info for user
let currentClass = null; // {id, name, inviteCode, ...}
let channels = []; // channels in current class
let currentChannel = null; // {id, name}
let messagesRef = null;
let presenceRef = null;
let typingRef = null;
let messageListener = null;
let presenceListener = null;

/* -------------------------
   Helpers
------------------------- */
function $(id){return document.getElementById(id);}
function showModal(html){
  $('modal-body').innerHTML = html;
  $('modal').style.display = 'flex';
}
$('modal-close').onclick = ()=> $('modal').style.display='none';

function escapeHtml(str){
  if(!str) return '';
  return str.replace(/[&<>"'`]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'}[s]));
}

/* -------------------------
   UI rendering
------------------------- */

function renderUser(){
  if(!currentUser){ $('user-name').textContent = 'Not signed in'; $('user-email').textContent=''; return; }
  $('user-name').textContent = currentUser.name || currentUser.email.split('@')[0];
  $('user-email').textContent = currentUser.email;
}

function renderClasses(){
  const container = $('classes-list');
  container.innerHTML = '';
  classes.forEach((c, i)=>{
    const el = document.createElement('div');
    el.className = 'class-item card';
    if(currentClass && currentClass.id === c.id) el.classList.add('class-selected');
    el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-weight:700">${escapeHtml(c.name)}</div>
        <div class="small">Code: ${escapeHtml(c.inviteCode || '')}</div>
      </div>
      <div style="text-align:right">
        <div class="small">Members: â€”</div>
        <div style="margin-top:8px"><button class="btn btn-ghost" onclick="event.stopPropagation(); copyCode('${escapeHtml(c.inviteCode)}')">Copy</button></div>
      </div>
    </div>`;
    el.onclick = ()=> selectClassByIndex(i);
    container.appendChild(el);
  });
}

function renderChannels(){
  const container = $('channels-list');
  container.innerHTML = '';
  if(!currentClass) return;
  // default channel
  const addChannelBtn = document.createElement('div');
  addChannelBtn.style.marginBottom='8px';
  addChannelBtn.innerHTML = `<div style="display:flex;gap:8px;align-items:center">
    <input id="new-channel-name" placeholder="New channel name" style="flex:1;padding:8px;border-radius:8px;border:1px solid #eef" />
    <button class="btn btn-primary" id="create-channel-btn">Create</button>
  </div>`;
  container.appendChild(addChannelBtn);
  $('create-channel-btn').onclick = ()=> {
    const name = $('new-channel-name').value.trim();
    if(!name) return alert('Enter channel name');
    createChannel(name);
  };

  channels.forEach(ch => {
    const el = document.createElement('div');
    el.className = 'channel';
    if(currentChannel && currentChannel.id === ch.id) el.classList.add('active');
    el.textContent = '# ' + ch.name;
    el.onclick = ()=> selectChannel(ch.id);
    container.appendChild(el);
  });
}

/* -------------------------
   Auth
------------------------- */

function showLoginForm(){
  showModal(`
    <h3>Login</h3>
    <input id="li-email" placeholder="Email" style="width:100%;padding:8px;border-radius:8px;border:1px solid #eee" /><br/><br/>
    <input id="li-pass" type="password" placeholder="Password" style="width:100%;padding:8px;border-radius:8px;border:1px solid #eee" /><br/><br/>
    <div style="text-align:right"><button id="li-submit" class="btn btn-primary">Login</button></div>
    <div style="margin-top:8px"><small>Or create an account below</small></div>
    <hr/>
    <input id="su-name" placeholder="Full name" style="width:100%;padding:8px;border-radius:8px;border:1px solid #eee" /><br/><br/>
    <input id="su-email" placeholder="Email" style="width:100%;padding:8px;border-radius:8px;border:1px solid #eee" /><br/><br/>
    <input id="su-pass" type="password" placeholder="Password (min 6)" style="width:100%;padding:8px;border-radius:8px;border:1px solid #eee" /><br/><br/>
    <div style="text-align:right"><button id="su-submit" class="btn btn-primary">Sign up</button></div>
  `);
  $('li-submit').onclick = ()=>{
    const email = $('li-email').value.trim(), pass = $('li-pass').value;
    if(!email||!pass) return alert('fill fields');
    auth.signInWithEmailAndPassword(email, pass).then(()=> $('modal').style.display='none')
      .catch(e=> alert(e.message));
  };
  $('su-submit').onclick = ()=>{
    const name = $('su-name').value.trim(), email = $('su-email').value.trim(), pass = $('su-pass').value;
    if(!name||!email||!pass) return alert('fill fields');
    if(pass.length<6) return alert('password min 6');
    auth.createUserWithEmailAndPassword(email, pass)
      .then(uc=> uc.user.updateProfile({displayName:name}))
      .then(()=> { $('modal').style.display='none'; alert('Account created.'); })
      .catch(e=> alert(e.message));
  };
}

/* -------------------------
   Class actions
------------------------- */

function createClass(name){
  const id = Date.now().toString();
  const inviteCode = Math.random().toString(36).substring(2,8).toUpperCase();
  const info = { id, name, inviteCode, createdBy: currentUser.uid, createdAt: Date.now() };
  // Write in two places: classes/{id}/info and users/{uid}/classes/{id}
  const updates = {};
  updates[`/classes/${id}/info`] = info;
  updates[`/users/${currentUser.uid}/classes/${id}`] = info;
  db.ref().update(updates)
    .then(()=> { loadUserClasses(); selectClassById(id); $('modal').style.display='none'; })
    .catch(e=> alert(e.message));
}

function showCreateClass(){
  showModal(`
    <h3>Create Class</h3>
    <input id="new-class-name-modal" placeholder="Class name (e.g., Math 3A)" style="width:100%;padding:8px;border-radius:8px;border:1px solid #eee" />
    <div style="text-align:right;margin-top:8px"><button id="new-class-create" class="btn btn-primary">Create</button></div>
  `);
  $('new-class-create').onclick = ()=>{
    const name = $('new-class-name-modal').value.trim();
    if(!name) return alert('enter name');
    createClass(name);
  };
}

function copyCode(code){ navigator.clipboard.writeText(code||''); alert('Code copied'); }

function joinClassWithCode(){
  const code = prompt('Enter invite code:').toUpperCase().trim();
  if(!code) return;
  db.ref('classes').orderByChild('info/inviteCode').equalTo(code).once('value')
    .then(snap=>{
      if(!snap.exists()) return alert('Invalid code');
      snap.forEach(child=>{
        const info = child.val().info;
        // add to user's classes
        db.ref(`users/${currentUser.uid}/classes/${info.id}`).set(info)
          .then(()=> { loadUserClasses(); alert('Joined ' + info.name); })
          .catch(e=> alert(e.message));
      });
    }).catch(e=> alert(e.message));
}

/* -------------------------
   Load classes for user
------------------------- */
function loadUserClasses(){
  if(!currentUser) return;
  const ref = db.ref(`users/${currentUser.uid}/classes`);
  ref.off();
  ref.on('value', snap=>{
    const val = snap.val();
    classes = val ? Object.values(val) : [];
    renderClasses();
  });
}

/* -------------------------
   Select class
   Avoid JSON.parse bugs -> always pass objects or ids
------------------------- */

function selectClassByIndex(i){
  if(!classes[i]) return;
  selectClass(classes[i]);
}

function selectClassById(id){
  const cls = classes.find(c=>c.id===id);
  if(cls) selectClass(cls);
}

/* IMPORTANT: accept either object or id, but do not JSON.parse blindly */
function selectClass(cls){
  // cls might be an object already
  if(typeof cls === 'string'){ // if an id passed
    const found = classes.find(c=>c.id===cls);
    if(!found) return alert('Class not found');
    cls = found;
  }
  currentClass = cls;
  currentChannel = null;
  channels = [];
  // UI updates
  $('class-title').textContent = currentClass.name;
  $('class-sub').textContent = 'Invite code: ' + (currentClass.inviteCode || '-');
  $('message-input').disabled = true;
  $('send-btn').disabled = true;
  renderClasses();
  // load channels & class data
  loadChannelsForClass(currentClass.id);
  setupPresence(currentClass.id);
  // load channels â†’ will auto-select default channel when available
}

/* -------------------------
   Channels & Messages
------------------------- */

function loadChannelsForClass(classId){
  const ref = db.ref(`classes/${classId}/channels`);
  ref.off();
  ref.on('value', snap=>{
    const val = snap.val();
    channels = val ? Object.values(val).map(c => c.info ? c.info : c) : [];
    // ensure there's a default general channel
    if(!channels.find(ch=>ch.name==='general')){
      const chId = 'general';
      const info = { id: chId, name:'general', createdAt: Date.now() };
      db.ref(`classes/${classId}/channels/${chId}/info`).set(info).catch(()=>{});
      // channels will be picked up by the ref listener shortly
      return;
    }
    renderChannels();
    // auto-select first channel if none selected
    if(!currentChannel && channels.length>0){
      selectChannel(channels[0].id);
    } else {
      renderChannels();
    }
  });
}

function createChannel(name){
  const chId = name.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-_]/g,'') + '-' + Date.now().toString().slice(-4);
  const info = { id: chId, name, createdAt: Date.now(), createdBy: currentUser.uid };
  db.ref(`classes/${currentClass.id}/channels/${chId}/info`).set(info)
    .then(()=> {
      $('new-channel-name').value = '';
      // listener will update channels
    })
    .catch(e=> alert(e.message));
}

function selectChannel(channelId){
  // stop previous listeners
  if(messageListener && messagesRef) messagesRef.off('value', messageListener);
  if(typingRef) typingRef.child(currentChannel ? currentChannel.id : '').child(currentUser.uid).remove().catch(()=>{});
  currentChannel = channels.find(c => c.id === channelId);
  renderChannels();
  // enable input
  $('message-input').disabled = false;
  $('send-btn').disabled = false;
  // load messages
  messagesRef = db.ref(`classes/${currentClass.id}/channels/${currentChannel.id}/messages`);
  messageListener = messagesRef.orderByChild('timestamp').limitToLast(200).on('value', snap=>{
    const val = snap.val();
    const msgs = val ? Object.values(val).sort((a,b)=>a.timestamp-b.timestamp) : [];
    renderMessages(msgs);
  });
  // listen for typing
  typingRef = db.ref(`typing/${currentClass.id}/${currentChannel.id}`);
  typingRef.on('value', s=>{
    const t = s.val() || {};
    const typingUsers = Object.keys(t).filter(uid => t[uid] && uid !== currentUser.uid);
    $('typing-indicator').textContent = typingUsers.length ? `${typingUsers.length} typing...` : '';
  });
}

/* -------------------------
   Messages UI
------------------------- */

function renderMessages(msgs){
  const area = $('chat-area');
  area.innerHTML = '';
  if(msgs.length===0){
    area.innerHTML = '<div class="muted" style="text-align:center;margin-top:20px">No messages yet â€” say hi ðŸ‘‹</div>';
  } else {
    msgs.forEach(m=>{
      const el = document.createElement('div');
      el.className = 'msg' + (m.authorId === currentUser.uid ? ' me' : '');
      const avatar = document.createElement('div');
      avatar.style.minWidth='44px';
      avatar.style.textAlign='center';
      avatar.innerHTML = `<div style="width:36px;height:36px;border-radius:8px;background:#eef2ff;display:inline-flex;align-items:center;justify-content:center;font-weight:700;color:var(--indigo)">${escapeHtml((m.authorName||'U').charAt(0).toUpperCase())}</div>`;
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.innerHTML = `<div style="font-size:13px;font-weight:700">${escapeHtml(m.authorName||'Unknown')}</div>
        <div style="margin-top:6px">${escapeHtml(m.text)}</div>
        <div class="small muted" style="margin-top:6px">${new Date(m.timestamp).toLocaleString()}</div>`;
      el.appendChild(avatar);
      el.appendChild(bubble);
      area.appendChild(el);
    });
  }
  // scroll to bottom
  area.scrollTop = area.scrollHeight;
}

/* -------------------------
   Send message + typing
------------------------- */

$('send-btn').onclick = sendMessage;
$('message-input').addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
  // Typing indicator: set true, then debounce to false after interval
  setTyping(true);
  if(window._typingTimeout) clearTimeout(window._typingTimeout);
  window._typingTimeout = setTimeout(()=> setTyping(false), 1500);
});

function sendMessage(){
  const text = $('message-input').value.trim();
  if(!text || !currentClass || !currentChannel) return;
  const id = Date.now().toString() + '-' + Math.random().toString(36).slice(2,6);
  const msg = {
    id,
    authorId: currentUser.uid,
    authorName: currentUser.displayName || currentUser.email.split('@')[0],
    text,
    timestamp: Date.now()
  };
  const ref = db.ref(`classes/${currentClass.id}/channels/${currentChannel.id}/messages/${id}`);
  ref.set(msg)
    .then(()=> {
      $('message-input').value = '';
      setTyping(false);
    }).catch(e=> alert(e.message));
}

function setTyping(state){
  if(!currentClass || !currentChannel) return;
  const ref = db.ref(`typing/${currentClass.id}/${currentChannel.id}/${currentUser.uid}`);
  if(state){
    ref.set(true);
  } else {
    ref.remove().catch(()=>{});
  }
}

/* -------------------------
   Presence (who's online)
------------------------- */

function setupPresence(classId){
  // clear previous presence listeners
  if(presenceListener && presenceRef) presenceRef.off('value', presenceListener);
  presenceRef = db.ref(`presence/${classId}`);
  const userPresenceRef = db.ref(`presence/${classId}/${currentUser.uid}`);
  // set presence true while window open, set lastSeen on disconnect
  userPresenceRef.set({ name: currentUser.displayName || currentUser.email.split('@')[0], online: true, lastSeen: Date.now() });
  userPresenceRef.onDisconnect().set({ name: currentUser.displayName || currentUser.email.split('@')[0], online: false, lastSeen: Date.now() });
  presenceListener = presenceRef.on('value', snap=>{
    const val = snap.val() || {};
    const online = Object.values(val).filter(p=>p && p.online).length;
    $('online-count').textContent = `Online: ${online}`;
    // show who is online in presence-info
    const onlineNames = Object.values(val).filter(p=>p && p.online).map(p=>p.name);
    $('presence-info').textContent = onlineNames.length ? 'Online: ' + onlineNames.join(', ') : 'No one online';
  });
}

/* -------------------------
   Auth state handlers
------------------------- */

auth.onAuthStateChanged(user=>{
  if(user){
    currentUser = user;
    renderUser();
    loadUserClasses();
    // if newly signed up and no classes, optionally create demo
  } else {
    currentUser = null;
    // show login prompt
    renderUser();
    classes = [];
    currentClass = null;
    channels = [];
    currentChannel = null;
    renderClasses();
    $('class-title').textContent = 'Please login';
    $('chat-area').innerHTML = '<div class="muted" style="text-align:center;margin-top:20px">Not signed in</div>';
  }
});

/* -------------------------
   Load user into UI
------------------------- */

function renderInitial(){
  // wire buttons
  $('create-class-btn').onclick = showCreateClass;
  $('join-code-btn').onclick = joinClassWithCode;
  $('logout-btn').onclick = ()=> auth.signOut();
  $('send-btn').disabled = true;
  $('message-input').disabled = true;
}

renderInitial();

/* -------------------------
   Utility: load classes snapshot once on start (if signed in)
------------------------- */

function loadUserClassesOnce(){
  if(!currentUser) return;
  db.ref(`users/${currentUser.uid}/classes`).once('value').then(snap=>{
    const v = snap.val();
    classes = v ? Object.values(v) : [];
    renderClasses();
  });
}

// Expose some functions for debug / simple UI
window.selectClassByIndex = selectClassByIndex;
window.copyCode = copyCode;
window.selectClassById = selectClassById;

/* ---- Safety note: optionally load classes if page loaded and already logged in ---- */
setTimeout(()=>{ if(auth.currentUser){ currentUser = auth.currentUser; renderUser(); loadUserClasses(); } }, 500);

</script>
</body>
</html>
