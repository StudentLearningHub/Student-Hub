<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Student Hub - Collaborate & Study</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #EBF4FF 0%, #E0E7FF 100%);
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 2rem; }
        .btn { 
            padding: 0.75rem 1.5rem; 
            border: none; 
            border-radius: 0.5rem; 
            font-weight: 600; 
            cursor: pointer; 
            transition: 0.2s;
            font-size: 1rem;
        }
        .btn-primary { background: #4F46E5; color: white; }
        .btn-primary:hover { background: #4338CA; }
        .btn-secondary { background: #F3F4F6; color: #374151; }
        .btn-secondary:hover { background: #E5E7EB; }
        .input { 
            width: 100%; 
            padding: 0.75rem 1rem; 
            border: 1px solid #D1D5DB; 
            border-radius: 0.5rem; 
            font-size: 1rem;
            margin-bottom: 1rem;
        }
        .input:focus { outline: none; border-color: #4F46E5; box-shadow: 0 0 0 3px rgba(79,70,229,0.1); }
        .sidebar { 
            width: 16rem; 
            background: white; 
            border-right: 1px solid #E5E7EB; 
            height: 100vh; 
            position: fixed;
            display: flex;
            flex-direction: column;
        }
        .main-content { margin-left: 16rem; padding: 2rem; min-height: 100vh; }
        .tab-btn { 
            width: 100%; 
            text-align: left; 
            padding: 0.75rem 1rem; 
            border: none; 
            background: transparent; 
            cursor: pointer; 
            border-radius: 0.5rem; 
            margin-bottom: 0.5rem;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .tab-btn:hover { background: #F3F4F6; }
        .tab-btn.active { background: #EEF2FF; color: #4F46E5; font-weight: 600; }
        .modal { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0,0,0,0.5); 
            display: none; 
            align-items: center; 
            justify-content: center;
            z-index: 1000;
        }
        .modal.show { display: flex; }
        .modal-content { 
            background: white; 
            border-radius: 1rem; 
            padding: 2rem; 
            max-width: 28rem; 
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .grid { display: grid; gap: 1rem; }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .flex { display: flex; }
        .flex-between { justify-content: space-between; }
        .flex-center { align-items: center; justify-content: center; }
        .gap-1 { gap: 0.5rem; }
        .gap-2 { gap: 1rem; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-4 { margin-bottom: 2rem; }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .p-1 { padding: 0.5rem; }
        .p-2 { padding: 1rem; }
        .text-center { text-align: center; }
        .text-sm { font-size: 0.875rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .text-gray-600 { color: #4B5563; }
        .text-gray-800 { color: #1F2937; }
        .text-indigo-600 { color: #4F46E5; }
        .bg-indigo-600 { background: #4F46E5; }
        .bg-indigo-50 { background: #EEF2FF; }
        .bg-indigo-100 { background: #E0E7FF; }
        .rounded-full { border-radius: 9999px; }
        .badge { 
            display: inline-block; 
            padding: 0.25rem 0.75rem; 
            background: #E0E7FF; 
            color: #4338CA; 
            border-radius: 9999px; 
            font-size: 0.875rem;
        }
        .avatar { 
            width: 2.5rem; 
            height: 2.5rem; 
            border-radius: 50%; 
            background: #4F46E5; 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: 600;
            flex-shrink: 0;
        }
        .icon-circle { 
            width: 4rem; 
            height: 4rem; 
            background: #4F46E5; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            font-size: 2rem;
            margin: 0 auto 1rem;
        }
        .border-dashed { 
            border: 2px dashed #C7D2FE; 
        }
        .border-dashed:hover { border-color: #818CF8; }
        h1 { font-size: 1.875rem; font-weight: 700; color: #1F2937; margin-bottom: 1.5rem; }
        h2 { font-size: 1.25rem; font-weight: 600; color: #1F2937; margin-bottom: 1rem; }
        h3 { font-size: 1.125rem; font-weight: 600; color: #1F2937; }
        textarea { resize: vertical; min-height: 100px; }
        @media (max-width: 768px) {
            .sidebar { width: 100%; height: auto; position: relative; }
            .main-content { margin-left: 0; }
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
        }
    </style>

    <!-- Updated Firebase SDK (Latest Compat Version - December 2025) -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
</head>
<body>
    <div id="app">
        <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center;">
            <div class="card text-center">
                <div style="width: 3rem; height: 3rem; border: 4px solid #4F46E5; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
                <p class="text-gray-600">Loading...</p>
            </div>
        </div>
    </div>

    <style>
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>

<script>
// ---- Student Hub with Guest Mode Support ----

// Globals
let auth, db;
let currentUser = null;
let currentClass = null;
let classes = [];
let deadlines = [];
let posts = [];
let groups = [];
let chatMessages = [];
let currentTab = 'deadlines';

const GUEST_UID = 'guest-user-0001'; // Shared guest ID (simple demo mode)

// Utility: show error screen
function showError(message) {
    document.getElementById('app').innerHTML = 
        '<div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 2rem;">' +
        '<div class="card text-center" style="max-width: 28rem;">' +
        '<h2 style="color: #DC2626; margin-bottom: 1rem;">Error</h2>' +
        '<p class="text-gray-600 mb-2">' + message + '</p>' +
        '<button onclick="location.reload()" class="btn btn-primary mt-2">Refresh</button>' +
        '</div></div>';
}

// Generate random fun guest name
function generateGuestName() {
    const adjectives = ['Quick','Smart','Brave','Clever','Happy','Cool','Wise','Bold','Calm','Bright','Swift','Keen','Sharp','Neat','Kind'];
    const animals = ['Fox','Bear','Lion','Wolf','Eagle','Shark','Panda','Tiger','Owl','Hawk','Deer','Cat','Dog','Rabbit','Koala'];
    const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
    const animal = animals[Math.floor(Math.random() * animals.length)];
    const num = Math.floor(Math.random() * 900) + 100;
    return `${adj}${animal}${num}`;
}

// Continue as Guest
function continueAsGuest() {
    const guestName = generateGuestName();
    currentUser = { id: GUEST_UID, name: guestName, email: 'guest@example.com', isGuest: true };
    loadUserClasses();
    render();
    alert(`Welcome, ${guestName}! You're in guest mode ‚Äì perfect for trying things out!`);
}

// Firebase listeners
function loadUserClasses() {
    if (!currentUser || !db) return;
    db.ref('users/' + currentUser.id + '/classes').on('value', function(snapshot) {
        classes = snapshot.val() ? Object.values(snapshot.val()) : [];
        render();
    });
}

function loadClassData(classId) {
    if (!classId || !db) return;

    db.ref('classes/' + classId + '/deadlines').on('value', snapshot => {
        deadlines = snapshot.val() ? Object.values(snapshot.val()) : [];
        render();
    });

    db.ref('classes/' + classId + '/posts').on('value', snapshot => {
        posts = snapshot.val() ? Object.values(snapshot.val()) : [];
        render();
    });

    db.ref('classes/' + classId + '/groups').on('value', snapshot => {
        groups = snapshot.val() ? Object.values(snapshot.val()) : [];
        render();
    });

    db.ref('classes/' + classId + '/chat').on('value', snapshot => {
        chatMessages = snapshot.val() ? Object.values(snapshot.val()) : [];
        chatMessages.sort((a,b) => (a.timestamp||0) - (b.timestamp||0));
        render();
    });
}

// Auth helpers
function handleSignup(name, email, password) {
    if (!email || !password) { alert('Please fill in all fields'); return; }
    if (password.length < 6) { alert('Password must be at least 6 characters'); return; }

    auth.createUserWithEmailAndPassword(email, password)
        .then(cred => name ? cred.user.updateProfile({ displayName: name }) : null)
        .then(() => alert('Account created successfully!'))
        .catch(err => alert('Error: ' + err.message));
}

function handleLogin(email, password) {
    if (!email || !password) { alert('Please fill in all fields'); return; }
    auth.signInWithEmailAndPassword(email, password)
        .catch(err => alert('Error: ' + err.message));
}

function handleLogout() {
    auth.signOut().then(() => {
        currentUser = null; currentClass = null; classes = []; deadlines = []; posts = []; groups = []; chatMessages = [];
        render();
    });
}

// Class CRUD (unchanged)
function createClass(name) {
    if (!name || !name.trim()) { alert('Please enter a class name'); return; }

    const newClass = {
        id: Date.now().toString(),
        name: name.trim(),
        inviteCode: Math.random().toString(36).substring(2, 8).toUpperCase(),
        createdBy: currentUser.id,
        createdAt: Date.now()
    };

    db.ref('users/' + currentUser.id + '/classes/' + newClass.id).set(newClass);
    db.ref('classes/' + newClass.id + '/info').set(newClass);
    currentClass = newClass;
    loadClassData(newClass.id);
    closeModals();
    render();
}

function joinWithCode() {
    const code = prompt('Enter the class invite code:');
    if (!code) return;
    const upperCode = code.toUpperCase().trim();
    db.ref('classes').once('value')
        .then(snapshot => {
            let found = false;
            snapshot.forEach(child => {
                const classData = child.val();
                if (classData.info && classData.info.inviteCode === upperCode) {
                    found = true;
                    db.ref('users/' + currentUser.id + '/classes/' + classData.info.id).set(classData.info)
                        .then(() => alert('Successfully joined ' + classData.info.name + '!'))
                        .catch(err => alert('Error: ' + err.message));
                }
            });
            if (!found) alert('Invalid code. Please check and try again.');
        });
}

function selectClass(cls) {
    currentClass = cls;
    currentTab = 'deadlines';
    loadClassData(cls.id);
    render();
}

function selectClassByIndex(i) { if (classes[i]) selectClass(classes[i]); }

function backToClasses() { currentClass = null; render(); }

// Add items (unchanged)
function addDeadline(title, date, subject) {
    if (!title || !date) { alert('Please fill in title and date'); return; }
    const deadline = { id: Date.now().toString(), title, date, subject: subject||'', createdBy: currentUser.id, createdAt: Date.now() };
    db.ref('classes/' + currentClass.id + '/deadlines/' + deadline.id).set(deadline);
}

function addPost(title, description) {
    if (!title) { alert('Please enter a title'); return; }
    const post = { id: Date.now().toString(), title, description: description||'', author: currentUser.name, authorId: currentUser.id, timestamp: Date.now() };
    db.ref('classes/' + currentClass.id + '/posts/' + post.id).set(post);
}

function addGroup(name, time, members) {
    if (!name) { alert('Please enter a group name'); return; }
    const group = { id: Date.now().toString(), name, time: time||'', members: members||'', creator: currentUser.name, creatorId: currentUser.id, createdAt: Date.now() };
    db.ref('classes/' + currentClass.id + '/groups/' + group.id).set(group);
}

function sendChatMessage() {
    const input = document.getElementById('chat-input');
    if (!input || !input.value.trim()) return;
    const message = { id: Date.now().toString(), sender: currentUser.name, senderId: currentUser.id, text: input.value.trim(), timestamp: Date.now() };
    db.ref('classes/' + currentClass.id + '/chat/' + message.id).set(message);
    input.value = '';
}

// Submit helpers
function submitLogin() { handleLogin(document.getElementById('login-email').value, document.getElementById('login-password').value); }
function submitSignup() { handleSignup(document.getElementById('signup-name').value, document.getElementById('signup-email').value, document.getElementById('signup-password').value); }
function submitDeadline() { addDeadline(document.getElementById('deadline-title').value, document.getElementById('deadline-date').value, document.getElementById('deadline-subject').value); }
function submitPost() { addPost(document.getElementById('post-title').value, document.getElementById('post-description').value); }
function submitGroup() { addGroup(document.getElementById('group-name').value, document.getElementById('group-time').value, document.getElementById('group-members').value); }

// Modal helpers
function showCreateClassModal() {
    const modal = document.getElementById('modal-overlay'); modal.className = 'modal show';
    document.getElementById('modal-content').innerHTML = '<h2 class="mb-2">Create New Class</h2>' +
        '<input type="text" id="new-class-name" placeholder="Class Name (e.g., Math 3A)" class="input" autofocus>' +
        '<div class="flex gap-1"><button onclick="closeModals()" class="btn btn-secondary" style="flex:1;">Cancel</button>' +
        '<button onclick="createClass(document.getElementById(\'new-class-name\').value)" class="btn btn-primary" style="flex:1;">Create</button></div>';
}

function showInviteModal() {
    const modal = document.getElementById('modal-overlay'); modal.className = 'modal show';
    document.getElementById('modal-content').innerHTML = '<h2 class="mb-2">Invite Students</h2>' +
        '<p class="text-gray-600 mb-2">Share this code:</p>' +
        '<div class="bg-indigo-50 p-2 mb-2" style="border-radius:0.5rem;"><p class="text-center text-3xl font-bold text-indigo-600">' + (currentClass?.inviteCode || '') + '</p></div>' +
        '<button onclick="navigator.clipboard.writeText(currentClass.inviteCode); alert(\'Copied!\')" class="btn btn-primary" style="width:100%;">üìã Copy Code</button>' +
        '<button onclick="closeModals()" class="btn btn-secondary" style="width:100%;">Close</button>';
}

function closeModals() { document.getElementById('modal-overlay').className = 'modal'; }

// Tabs
function showTab(tab) {
    currentTab = tab;
    ['deadlines', 'homework', 'chat', 'groups'].forEach(t => {
        document.getElementById('tab-content-' + t).style.display = t === tab ? 'block' : 'none';
        const btn = document.getElementById('tab-' + t);
        if (btn) btn.className = t === tab ? 'tab-btn active' : 'tab-btn';
    });
}

// Render functions
function render() {
    if (!currentUser) document.getElementById('app').innerHTML = renderLogin();
    else if (!currentClass) document.getElementById('app').innerHTML = renderClassSelection();
    else document.getElementById('app').innerHTML = renderMainApp();
}

function renderLogin() {
    return `<div style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:1rem;">
        <div class="card" style="max-width:28rem;width:100%;">
            <div class="text-center mb-4"><div class="icon-circle">üìö</div><h1>Student Hub</h1><p class="text-gray-600">Collaborate, study, and succeed together</p></div>
            <div class="flex gap-1 mb-2">
                <button onclick="showLogin()" id="login-tab" class="btn btn-primary" style="flex:1;">Login</button>
                <button onclick="showSignup()" id="signup-tab" class="btn btn-secondary" style="flex:1;">Sign Up</button>
            </div>
            <div id="login-form">
                <input type="email" id="login-email" placeholder="Email" class="input">
                <input type="password" id="login-password" placeholder="Password" class="input">
                <button onclick="submitLogin()" class="btn btn-primary" style="width:100%;">Login</button>
            </div>
            <div id="signup-form" style="display:none;">
                <input type="text" id="signup-name" placeholder="Full Name" class="input">
                <input type="email" id="signup-email" placeholder="Email" class="input">
                <input type="password" id="signup-password" placeholder="Password (min 6 chars)" class="input">
                <button onclick="submitSignup()" class="btn btn-primary" style="width:100%;">Sign Up</button>
            </div>
            <div class="mt-2 text-center">
                <button onclick="continueAsGuest()" class="btn btn-secondary" style="width:100%;">Continue as Guest</button>
            </div>
            <p class="text-sm text-gray-600 text-center mt-2">üî• Powered by Firebase</p>
        </div>
    </div>`;
}

function renderClassSelection() {
    let classesHTML = '';
    if (classes.length > 0) {
        classesHTML = '<div class="mt-2"><h2>Your Classes</h2><div class="grid grid-3 gap-2">';
        classes.forEach((cls, i) => {
            classesHTML += `<button onclick="selectClassByIndex(${i})" class="card">
                <h3>${cls.name}</h3>
                <p class="text-sm text-gray-600 mt-1">Code: ${cls.inviteCode || ''}</p>
            </button>`;
        });
        classesHTML += '</div></div>';
    }
    return `<div class="container">
        <div class="flex flex-between mb-4"><div><h1>Welcome, ${currentUser.name}!</h1><p class="text-gray-600">Select or create a class</p></div>
        <button onclick="handleLogout()" class="btn btn-secondary">Logout</button></div>
        <div class="grid grid-2 gap-2 mb-2">
            <button onclick="showCreateClassModal()" class="card border-dashed text-center">
                <div style="font-size:3rem;margin-bottom:0.5rem;">‚ûï</div><h3>Create New Class</h3>
            </button>
            <button onclick="joinWithCode()" class="card text-center">
                <div style="font-size:3rem;margin-bottom:0.5rem;">‚úâÔ∏è</div><h3>Join with Code</h3>
            </button>
        </div>${classesHTML}
        <div id="modal-overlay" class="modal"><div onclick="event.stopPropagation()" class="modal-content" id="modal-content"></div></div>
    </div>`;
}

function renderMainApp() {
    return `<div class="flex">
        <div class="sidebar">
            <div class="p-2" style="border-bottom:1px solid #E5E7EB;">
                <h2 class="text-indigo-600">${currentClass.name}</h2>
                <p class="text-sm text-gray-600">${currentUser.name}</p>
            </div>
            <div style="flex:1;padding:1rem;">
                <button onclick="showTab('deadlines')" id="tab-deadlines" class="tab-btn ${currentTab==='deadlines'?'active':''}">üìÖ Deadlines</button>
                <button onclick="showTab('homework')" id="tab-homework" class="tab-btn ${currentTab==='homework'?'active':''}">üí¨ Homework Help</button>
                <button onclick="showTab('chat')" id="tab-chat" class="tab-btn ${currentTab==='chat'?'active':''}">üí¨ General Chat</button>
                <button onclick="showTab('groups')" id="tab-groups" class="tab-btn ${currentTab==='groups'?'active':''}">üë• Study Groups</button>
            </div>
            <div class="p-2" style="border-top:1px solid #E5E7EB;">
                <button onclick="showInviteModal()" class="btn btn-primary" style="width:100%;margin-bottom:0.5rem;">‚úâÔ∏è Invite Students</button>
                <button onclick="backToClasses()" class="btn btn-secondary" style="width:100%;">Change Class</button>
            </div>
        </div>
        <div class="main-content">
            <div id="tab-content-deadlines" style="display:${currentTab==='deadlines'?'block':'none'}">${renderDeadlines()}</div>
            <div id="tab-content-homework" style="display:${currentTab==='homework'?'block':'none'}">${renderHomework()}</div>
            <div id="tab-content-chat" style="display:${currentTab==='chat'?'block':'none'}">${renderChat()}</div>
            <div id="tab-content-groups" style="display:${currentTab==='groups'?'block':'none'}">${renderGroups()}</div>
        </div>
        <div id="modal-overlay" class="modal"><div onclick="event.stopPropagation()" class="modal-content" id="modal-content"></div></div>
    </div>`;
}

// Render tab contents (same as your original, slightly cleaned)
function renderDeadlines() { /* ... your original renderDeadlines code ... */ }
function renderHomework() { /* ... your original renderHomework code ... */ }
function renderChat() { /* ... your original renderChat code ... */ }
function renderGroups() { /* ... your original renderGroups code ... */ }

// (Paste the exact renderDeadlines, renderHomework, renderChat, renderGroups functions from your original code here - they are unchanged)

function showLogin() { document.getElementById('login-tab').className='btn btn-primary'; document.getElementById('signup-tab').className='btn btn-secondary'; document.getElementById('login-form').style.display='block'; document.getElementById('signup-form').style.display='none'; }
function showSignup() { document.getElementById('signup-tab').className='btn btn-primary'; document.getElementById('login-tab').className='btn btn-secondary'; document.getElementById('signup-form').style.display='block'; document.getElementById('login-form').style.display='none'; }

// Initialize
window.addEventListener('load', () => {
    if (typeof firebase === 'undefined') { showError('Firebase scripts failed to load. Check your internet connection and refresh.'); return; }

    const firebaseConfig = {
        apiKey: "AIzaSyCfijY0V4DQDOkrb13ludHiGRFtWsk8Bsg",
        authDomain: "student-hub-450ab.firebaseapp.com",
        databaseURL: "https://student-hub-450ab-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "student-hub-450ab",
        storageBucket: "student-hub-450ab.firebasestorage.app",
        messagingSenderId: "149361370872",
        appId: "1:149361370872:web:e3ee75310e59d92f3bbd0d"
    };

    firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    db = firebase.database();

    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = { id: user.uid, email: user.email, name: user.displayName || user.email.split('@')[0] };
            loadUserClasses();
        } else {
            currentUser = null;
            render();
        }
    });

    render();
});
</script>
</body>
</html>